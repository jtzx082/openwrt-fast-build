name: Build Nikki for OpenWrt x86_64

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  SDK_URL: https://mirror-03.infra.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
  NIKKI_URL: https://github.com/nikkinikki-org/OpenWrt-nikki.git
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 清理空间 (仅删除大型且无用组件，保留系统核心源配置)
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        
        # 安装编译依赖
        sudo apt-get -qq update
        sudo apt-get -qq install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc rsync wget unzip zstd file
        
        # 设置时区
        sudo timedatectl set-timezone "$TZ"

    - name: Download and Extract SDK
      run: |
        echo "Downloading SDK..."
        wget -qO sdk.tar.zst "$SDK_URL"
        echo "Extracting SDK..."
        tar -I zstd -xf sdk.tar.zst
        rm sdk.tar.zst
        SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk*")
        mv "$SDK_DIR" openwrt-sdk

    - name: Update Feeds & Add Nikki Source
      working-directory: ./openwrt-sdk
      run: |
        echo "Fixing feed sources..."
        # --- 关键修复：将不稳定源替换为 GitHub 镜像 ---
        sed -i 's|git.openwrt.org/openwrt/openwrt.git|github.com/openwrt/openwrt.git|g' feeds.conf.default
        
        # 增加 Git 缓存以防止网络抖动
        git config --global http.postBuffer 524288000
        
        echo "Updating feeds..."
        ./scripts/feeds update -a
        
        echo "Installing feeds..."
        ./scripts/feeds install -a
        
        echo "Cloning Nikki..."
        git clone --depth 1 $NIKKI_URL package/nikki
        
        echo "Refreshing feeds for Nikki..."
        ./scripts/feeds install -a

    - name: Compile Nikki Plugin
      working-directory: ./openwrt-sdk
      run: |
        echo "Starting Compilation..."
        # 尝试多核编译，如果失败则回退单核显示详细日志
        make package/nikki/compile -j$(nproc) V=s || make package/nikki/compile V=s

    - name: Package as .run file
      id: package
      working-directory: ./openwrt-sdk
      run: |
        mkdir -p release_output
        
        # 收集编译生成的 ipk 文件
        # 注意：有时候 feeds 更新后路径可能会有细微变化，使用 find 最稳妥
        find bin/ -name "nikki*.ipk" -exec cp {} release_output/ \;
        find bin/ -name "luci-app-nikki*.ipk" -exec cp {} release_output/ \;
        find bin/ -name "mihomo*.ipk" -exec cp {} release_output/ \; 
        
        echo "Collected IPKs:"
        ls -lh release_output/

        # --- 制作 .run 安装包 ---
        cd release_output
        tar -zcf payload.tar.gz *.ipk
        
        cat > install_script.sh << 'EOF'
        #!/bin/sh
        # Nikki Installer for OpenWrt
        export SKIP_LINES=14
        INSTALL_DIR=/tmp/nikki_install_temp
        mkdir -p $INSTALL_DIR
        tail -n +$SKIP_LINES "$0" | tar -zxf - -C $INSTALL_DIR
        echo "Installing Nikki packages..."
        cd $INSTALL_DIR
        opkg update
        opkg install *.ipk --force-reinstall --force-overwrite
        cd /
        rm -rf $INSTALL_DIR
        echo "Installation Complete!"
        exit 0
        EOF
        
        cat install_script.sh payload.tar.gz > nikki-installer-x86_64.run
        chmod +x nikki-installer-x86_64.run
        
        echo "PACKAGED_FILE=openwrt-sdk/release_output/nikki-installer-x86_64.run" >> $GITHUB_ENV
        echo "TAG_NAME=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PACKAGED_FILE }}
        tag_name: ${{ env.TAG_NAME }}
        name: Nikki x86_64 Release ${{ env.TAG_NAME }}
        body: |
          OpenWrt Nikki Plugin (x86_64)
          SDK: 24.10.4
          Install: Upload the .run file to your router and execute `sh nikki-installer-x86_64.run`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
