name: OpenWrt Auto Build & Release

on:
  workflow_dispatch:
    # 手动触发

env:
  # 固件分区大小 (MB)
  ROOTFS_SIZE: 1024
  # SDK 下载地址
  SDK_URL: https://mirror-03.infra.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
  # ImageBuilder 下载地址
  IB_URL: https://mirror-03.infra.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-imagebuilder-24.10.4-x86-64.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Prepare Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        # 增加 golang，防止因缺少 Go 环境导致 nikki 被跳过
        sudo -E apt-get -qq install build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev unzip wget rsync xsltproc zlib1g-dev xz-utils zstd golang
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Download and Extract SDK
      run: |
        mkdir -p openwrt/sdk
        echo ">>> Downloading SDK..."
        wget -q "${{ env.SDK_URL }}" -O sdk.tar.zst
        echo ">>> Extracting SDK..."
        tar -I zstd -xf sdk.tar.zst -C openwrt/sdk --strip-components=1
        rm sdk.tar.zst

    - name: Download and Extract Image Builder
      run: |
        mkdir -p openwrt/ib
        echo ">>> Downloading Image Builder..."
        wget -q "${{ env.IB_URL }}" -O ib.tar.zst
        echo ">>> Extracting Image Builder..."
        tar -I zstd -xf ib.tar.zst -C openwrt/ib --strip-components=1
        rm ib.tar.zst

    - name: Execute diy-part.sh and Install Feeds
      working-directory: openwrt/sdk
      run: |
        chmod +x $GITHUB_WORKSPACE/diy-part.sh
        $GITHUB_WORKSPACE/diy-part.sh
        
        # ------------------------------------------------------------------
        # 【关键修复】自动修正官方仓库目录结构
        # 官方 nikkinikki-org/OpenWrt-nikki 包含核心和界面，无需额外下载
        # 我们只需要确保它存在，脚本后续会自动找到里面的 luci-app-nikki
        
        # 清理可能存在的错误目录 (防止残留)
        rm -rf package/luci-app-nikki
        
        # 如果用户脚本把官方源下载到了 package/OpenWrt-nikki，保留它即可
        # 这里的关键是不要去改动它，让后面的 find 命令自己去搜
        # ------------------------------------------------------------------

        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure and Compile Custom Packages
      working-directory: openwrt/sdk
      run: |
        # 1. 生成初始配置
        make defconfig
        
        echo ">>> Activating packages from packages.list..."
        
        # 2. 强制开启包
        cat $GITHUB_WORKSPACE/packages.list | grep -v "^#" | grep -v "^$" | grep -v "^-" | while read pkg; do
          # 开启包本身
          echo "CONFIG_PACKAGE_$pkg=m" >> .config
          
          # 【强制开启 Go 依赖】
          # 确保 nikki 不会因为环境检测失败而被禁用
          if [[ "$pkg" == *"nikki"* ]]; then
             echo "CONFIG_PACKAGE_nikki=m" >> .config
             echo "CONFIG_PACKAGE_luci-app-nikki=m" >> .config
             echo "CONFIG_PACKAGE_golang=y" >> .config
             echo "CONFIG_golang=y" >> .config
          fi
        done
        
        # 3. 应用配置并下载依赖
        make defconfig
        echo ">>> Downloading package sources..."
        make package/downloads -j$(nproc) || true
        
        # 4. 【智能编译】根据 packages.list 精准查找编译路径
        echo ">>> Compiling user added packages..."
        
        cat $GITHUB_WORKSPACE/packages.list | grep -v "^#" | grep -v "^$" | grep -v "^-" | while read pkg; do
            echo ">>> Locate and build: $pkg"
            
            # 在 package 目录下查找该包名的 Makefile 所在的目录
            # 排除 feeds 目录，只找用户 clone 进来的
            PKG_PATH=$(find package -name "$pkg" -type d | grep -v "package/feeds" | head -n 1)
            
            if [ -z "$PKG_PATH" ]; then
                # 如果直接用包名找不到目录（比如包名是 luci-app-nikki 但目录叫 OpenWrt-nikki/luci-app-nikki）
                # 尝试更深度的搜索
                PKG_PATH=$(find package -path "*/$pkg" -type d | grep -v "package/feeds" | head -n 1)
            fi

            if [ -n "$PKG_PATH" ]; then
                echo "    Found path: $PKG_PATH"
                make "$PKG_PATH/compile" -j$(nproc) || make "$PKG_PATH/compile" -j1 V=s
            else
                echo "    WARNING: Could not find directory for package '$pkg'. Skipping..."
            fi
        done

    - name: Check and Move IPKs
      run: |
        mkdir -p openwrt/ib/packages
        
        echo ">>> Checking generated IPKs..."
        # 统计生成的 IPK 数量
        IPK_COUNT=$(find openwrt/sdk/bin/packages -name "*.ipk" | wc -l)
        
        if [ "$IPK_COUNT" -eq "0" ]; then
          echo "ERROR: No IPK files were generated! Compilation failed."
          exit 1
        fi
        
        find openwrt/sdk/bin/packages -name "*.ipk" -exec cp {} openwrt/ib/packages/ \;
        
        echo "=== IPKs Ready for Image Builder ==="
        ls -lh openwrt/ib/packages/

    - name: Generate Firmware
      working-directory: openwrt/ib
      run: |
        # 生成包列表字符串
        PACKAGES_LIST=$(cat $GITHUB_WORKSPACE/packages.list | grep -v "^#" | grep -v "^$" | tr '\n' ' ')
        echo ">>> Target Packages: $PACKAGES_LIST"
        
        make image PROFILE="generic" \
        PACKAGES="$PACKAGES_LIST" \
        CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.ROOTFS_SIZE }} \
        OPKG_ARGS="--force-checksum --force-signature"

    - name: Organize Firmware Files
      id: organize
      run: |
        mkdir -p firmware
        mv openwrt/ib/bin/targets/x86/64/* firmware/
        cd firmware
        gzip -d *.gz || true
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Generate Release Tag
      id: tag
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: OpenWrt ${{ steps.tag.outputs.release_tag }}
        body: |
          Auto-built OpenWrt Firmware.
          Target: x86/64
          RootFS Size: ${{ env.ROOTFS_SIZE }} MB
        files: firmware/*
