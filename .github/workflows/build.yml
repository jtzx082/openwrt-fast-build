name: OpenWrt Build & Release

on:
  workflow_dispatch:
    # 仅允许手动触发，修改文件不自动运行

env:
  # 固件分区大小 (MB)
  ROOTFS_SIZE: 1024
  # SDK 和 ImageBuilder 下载地址
  SDK_URL: https://mirror-03.infra.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
  IB_URL: https://mirror-03.infra.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-imagebuilder-24.10.4-x86-64.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Prepare Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        # 安装必要的编译依赖，包括 zstd (解压用) 和 golang (nikki 需要)
        sudo -E apt-get -qq install build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev unzip wget rsync xsltproc zlib1g-dev xz-utils zstd golang
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Download SDK and Image Builder
      run: |
        mkdir -p openwrt/sdk openwrt/ib
        
        echo ">>> Downloading SDK..."
        wget -q "${{ env.SDK_URL }}" -O sdk.tar.zst
        echo ">>> Extracting SDK..."
        tar -I zstd -xf sdk.tar.zst -C openwrt/sdk --strip-components=1
        rm sdk.tar.zst
        
        echo ">>> Downloading Image Builder..."
        wget -q "${{ env.IB_URL }}" -O ib.tar.zst
        echo ">>> Extracting Image Builder..."
        tar -I zstd -xf ib.tar.zst -C openwrt/ib --strip-components=1
        rm ib.tar.zst

    - name: Add Custom Sources (diy-part.sh)
      working-directory: openwrt/sdk
      run: |
        chmod +x $GITHUB_WORKSPACE/diy-part.sh
        $GITHUB_WORKSPACE/diy-part.sh
        
        # 更新 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure and Compile Packages
      working-directory: openwrt/sdk
      run: |
        # 1. 生成初始配置
        make defconfig
        
        echo ">>> Configuring packages from packages.list..."
        
        # 2. 强制开启 packages.list 中的包
        # 过滤掉注释行和空行
        grep -vE "^#|^$" $GITHUB_WORKSPACE/packages.list | while read pkg; do
          # 忽略以 - 开头的删除项
          if [[ $pkg != -* ]]; then
            echo "CONFIG_PACKAGE_$pkg=m" >> .config
            
            # 【特殊处理】如果包含 nikki，强制开启 golang 支持
            if [[ "$pkg" == *"nikki"* ]]; then
               echo "CONFIG_PACKAGE_golang=y" >> .config
               echo "CONFIG_golang=y" >> .config
            fi
          fi
        done
        
        # 3. 应用配置，让 SDK 解析依赖关系
        make defconfig
        
        # 4. 下载源码 (防止编译时网络超时)
        echo ">>> Downloading sources..."
        make package/downloads -j$(nproc) || true
        
        # 5. 【智能编译】根据包名查找真实路径进行编译
        echo ">>> Compiling custom packages..."
        
        grep -vE "^#|^$" $GITHUB_WORKSPACE/packages.list | while read pkg; do
            # 忽略以 - 开头的包和官方基础包(假设官方包不需要重编译，除非是 feeds 里的)
            # 这里我们只尝试编译用户自定义的包，避免编译整个系统
            if [[ $pkg != -* ]]; then
                echo ">>> Searching for package: $pkg"
                
                # 在 package 目录查找对应的 Makefile 所在目录
                # 排除 feeds/base 等官方目录，优先查找用户 clone 的目录
                PKG_PATH=$(find package -name "$pkg" -type d | grep -v "package/feeds" | head -n 1)
                
                # 如果找不到，尝试深度搜索 (例如 nikki 在 OpenWrt-nikki/nikki 下)
                if [ -z "$PKG_PATH" ]; then
                   PKG_PATH=$(find package -path "*/$pkg" -type d | grep -v "package/feeds" | head -n 1)
                fi
                
                if [ -n "$PKG_PATH" ]; then
                    echo "    Found path: $PKG_PATH"
                    echo "    Compiling..."
                    make "$PKG_PATH/compile" -j$(nproc) || make "$PKG_PATH/compile" -j1 V=s
                else
                    echo "    [INFO] Package '$pkg' not found in custom sources or is a system package. Skipping compile step."
                fi
            fi
        done

    - name: Transfer IPKs to Image Builder
      run: |
        mkdir -p openwrt/ib/packages
        
        echo ">>> Checking generated IPKs..."
        # 统计 SDK 编译出的 IPK (排除官方 feeds 里的，只看 bin 目录)
        find openwrt/sdk/bin/packages -name "*.ipk" -exec cp {} openwrt/ib/packages/ \;
        
        COUNT=$(ls openwrt/ib/packages/ | wc -l)
        if [ "$COUNT" -eq "0" ]; then
           echo "WARNING: No custom IPKs were generated. If you only used official packages, this is fine."
        else
           echo ">>> Found $COUNT custom packages."
           ls -lh openwrt/ib/packages/
        fi

    - name: Build Firmware
      working-directory: openwrt/ib
      run: |
        # 将 packages.list 转换为单行字符串
        PACKAGES_LIST=$(grep -vE "^#|^$" $GITHUB_WORKSPACE/packages.list | tr '\n' ' ')
        echo ">>> Building image with packages: $PACKAGES_LIST"
        
        make image PROFILE="generic" \
        PACKAGES="$PACKAGES_LIST" \
        CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.ROOTFS_SIZE }} \
        OPKG_ARGS="--force-checksum --force-signature"

    - name: Organize Files
      id: organize
      run: |
        mkdir -p firmware
        # 移动生成的镜像文件
        mv openwrt/ib/bin/targets/x86/64/* firmware/
        cd firmware
        # 解压 .gz 文件，方便直接使用 img
        gzip -d *.gz || true
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Generate Release Tag
      id: tag
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: OpenWrt ${{ steps.tag.outputs.release_tag }}
        body: |
          Auto-built OpenWrt Firmware (SDK + ImageBuilder).
          
          **Target:** x86/64
          **RootFS:** ${{ env.ROOTFS_SIZE }} MB
          **Source:** OpenWrt 24.10.4
          **Custom Packages:** Nikki, DDNS-Go
        files: firmware/*
